<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æ–‡ä»¶åˆå¹¶æ‹†åˆ†å·¥å…· </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .download-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f1ff 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid #e0e8ff;
        }

        .download-title {
            color: #4a5568;
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .download-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .download-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .download-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            text-decoration: none;
            color: white;
        }

        .download-item:active {
            transform: translateY(0);
        }

        .download-item.coming-soon {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .download-item.coming-soon:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .download-note {
            font-size: 0.85em;
            color: #6b7280;
            margin-top: 12px;
            line-height: 1.4;
        }

        .system-info {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .dev-mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .dev-mode-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .dev-mode-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .dev-mode-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .dev-mode-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .dev-mode-slider {
            background-color: #667eea;
        }

        input:checked + .dev-mode-slider:before {
            transform: translateX(26px);
        }

        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        .debug-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .debug-info pre {
            color: #666;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            color: #667eea;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f5f3ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f5f3ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .file-info {
            background: #f5f3ff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .file-icon {
            font-size: 1.5em;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
        }

        .file-size {
            font-size: 0.9em;
            color: #666;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 10px 5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-decoration: none;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button.secondary {
            background: #e0e0e0;
            color: #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .button.cancel {
            background: #f44336;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .progress {
            background: #f0f0f0;
            border-radius: 10px;
            height: 25px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: 600;
        }

        .progress-details {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .result {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .result.error {
            background: #ffebee;
        }

        .result h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .result.error h3 {
            color: #c62828;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .warning strong {
            display: block;
            margin-bottom: 5px;
        }

        .format-support {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .memory-warning {
            background: #ffecb3;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #8a6914;
        }

        .processing-mode {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .mode-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .mode-option.active {
            border-color: #667eea;
            background: #f5f3ff;
        }

        .mode-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .mode-option h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .mode-option p {
            font-size: 0.85em;
            color: #666;
        }

        .filename-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.85em;
        }

        .browser-compatibility {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
            color: #2e7d32;
        }

        .browser-compatibility.warning {
            background: #fff3cd;
            color: #856404;
        }

        .version-badge {
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .v3-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¬ è§†é¢‘æ–‡ä»¶åˆå¹¶æ‹†åˆ†å·¥å…· <span class="v3-badge">ç½‘é¡µç‰ˆ</span></h1>

        <div class="download-section">
            <div class="download-title">ğŸ’¾ å®¢æˆ·ç«¯ä¸‹è½½</div>
            <div class="download-options">
                <a href="#" class="download-item" onclick="downloadWindows()">
                    ğŸªŸ Windows ç‰ˆæœ¬
                </a>
                <span class="download-item coming-soon">
                    ğŸ¤–Android ç‰ˆæœ¬
                    <small style="font-size: 0.8em;">(å³å°†æ¨å‡º)</small>
                </span>
                <a href="#" class="download-item" onclick="downloadLinux()">
                    ğŸ§ Linux ç‰ˆæœ¬(è‡ªè¡Œç¼–è¯‘æµ‹è¯•)
                </a>
            </div>
            <div class="download-note">
                ğŸ“ æ¡Œé¢ç‰ˆæœ¬æ”¯æŒæ›´å¤§æ–‡ä»¶å¤„ç†,ç›®å‰ä»åœ¨æµ‹è¯•ä¸­ï¼Œå¯èƒ½æœ‰ä¸å…¼å®¹é—®é¢˜
            </div>
        </div>

        <div class="system-info" id="systemInfo">
            <strong>ğŸ” ç³»ç»Ÿæ£€æµ‹ï¼š</strong>æ­£åœ¨æ£€æµ‹æµè§ˆå™¨å…¼å®¹æ€§å’Œç³»ç»Ÿèµ„æº...
        </div>

        <div class="dev-mode-toggle">
            <span>ğŸ”§ å¼€å‘æ¨¡å¼ï¼š</span>
            <label class="dev-mode-switch">
                <input type="checkbox" id="devModeToggle" onchange="toggleDevMode()">
                <span class="dev-mode-slider"></span>
            </label>
            <span id="devModeStatus">å…³é—­</span>
        </div>

        <div class="debug-info" id="debugInfo">
            <h4>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h4>
            <pre id="debugContent"></pre>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('merge')">åˆå¹¶æ–‡ä»¶</button>
            <button class="tab" onclick="switchTab('split')">æ‹†åˆ†æ–‡ä»¶</button>
        </div>

        <!-- åˆå¹¶æ–‡ä»¶æ ‡ç­¾é¡µ -->
        <div id="merge" class="content active">
            <div class="format-support">
                <strong>ğŸ“‹ å…¼å®¹æ€§ï¼š</strong>
                <p>âœ…æµ‹è¯•é€šè¿‡ mp4,mkv,avi</p>
                <p style="font-size: 0.8em; color: #666; margin-top: 5px;">âš ï¸ å…¶ä»–æ ¼å¼ä¼ å…¥åï¼Œä¸ä¸€å®šå¯ä»¥æ’­æ”¾,ä¹Ÿå¯æµ‹è¯•éè§†é¢‘æ–‡ä»¶,ä½†æ˜¯æœªç»è¿‡ä»»ä½•éªŒè¯</p>
            </div>

            <div class="upload-area" onclick="document.getElementById('videoInput').click()"
                ondrop="handleDrop(event, 'video')" ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)">
                <div class="upload-icon">ğŸ¥</div>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ è§†é¢‘æ–‡ä»¶</p>
                <p style="font-size: 0.85em; color: #999; margin-top: 5px;">æ”¯æŒï¼šMP4, MKV, AVI, WebM, MOV, WMVç­‰</p>
                <input type="file" id="videoInput" class="file-input" accept="video/*,.mkv,.avi,.mp4,.mov,.wmv,.webm"
                    onchange="handleVideoSelect(event)">
            </div>

            <div id="videoInfo" style="display: none;"></div>

            <div class="upload-area" onclick="document.getElementById('fileInput').click()"
                ondrop="handleDrop(event, 'file')" ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)">
                <div class="upload-icon">ğŸ“</div>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ä»»æ„æ–‡ä»¶</p>
                <input type="file" id="fileInput" class="file-input" onchange="handleFileSelect(event)">
            </div>

            <div id="fileInfo" style="display: none;"></div>

            <div class="processing-mode" id="processingMode" style="display: none;">
                <div class="mode-option active" onclick="selectMode('memory')" data-mode="memory">
                    <h4>ğŸš€ å†…å­˜æ¨¡å¼</h4>
                    <p>é€‚åˆå°æ–‡ä»¶ï¼ˆ&lt;1GBï¼‰</p>
                </div>
                <div class="mode-option" onclick="selectMode('stream')" data-mode="stream">
                    <h4>ğŸ’¾ æµå¼æ¨¡å¼</h4>
                    <p>é€‚åˆå¤§æ–‡ä»¶ï¼Œä½å†…å­˜</p>
                </div>
            </div>

            <div id="memoryWarning" class="memory-warning" style="display: none;"></div>

            <button class="button" onclick="mergeFiles()" id="mergeBtn" style="display: none;">
                å¼€å§‹åˆå¹¶
            </button>
            <button class="button cancel" onclick="cancelOperation()" id="cancelBtn" style="display: none;">
                å–æ¶ˆæ“ä½œ
            </button>

            <div class="progress" id="mergeProgress">
                <div class="progress-bar" id="mergeProgressBar">0%</div>
            </div>
            <div class="progress-details" id="mergeProgressDetails"></div>

            <div class="result" id="mergeResult"></div>
        </div>

        <!-- æ‹†åˆ†æ–‡ä»¶æ ‡ç­¾é¡µ -->
        <div id="split" class="content">
            <div class="upload-area" onclick="document.getElementById('mergedInput').click()"
                ondrop="handleDrop(event, 'merged')" ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)">
                <div class="upload-icon">ğŸ“¦</div>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ åˆå¹¶åçš„æ–‡ä»¶</p>
                <p style="font-size: 0.85em; color: #999; margin-top: 5px;">âš ï¸ è¶…å¿«å›ºå®šä½ç½®è§£æ</p>
                <input type="file" id="mergedInput" class="file-input" onchange="handleMergedSelect(event)">
            </div>

            <div id="mergedInfo" style="display: none;"></div>

            <button class="button" onclick="splitFiles()" id="splitBtn" style="display: none;">
                å¼€å§‹æ‹†åˆ†
            </button>
            <button class="button cancel" onclick="cancelOperation()" id="splitCancelBtn" style="display: none;">
                å–æ¶ˆæ“ä½œ
            </button>

            <div class="progress" id="splitProgress">
                <div class="progress-bar" id="splitProgressBar">0%</div>
            </div>
            <div class="progress-details" id="splitProgressDetails"></div>

            <div class="result" id="splitResult"></div>
        </div>
    </div>

    <script>
        let videoFile = null;
        let attachFile = null;
        let mergedFile = null;
        let processingMode = 'memory';
        let currentOperation = null;
        let blobUrls = []; // è·Ÿè¸ªåˆ›å»ºçš„URLä»¥ä¾¿æ¸…ç†
        let devMode = false; // å¼€å‘æ¨¡å¼çŠ¶æ€

        // æ ¼å¼ç³»ç»Ÿé…ç½® 
        const CONFIG = {
            MAGIC_BYTES_V3: new TextEncoder().encode("MERGEDv3"), // 8å­—èŠ‚
            MAGIC_LENGTH_V3: 8,
            
            SIZE_LENGTH: 8, // ä½¿ç”¨8å­—èŠ‚(uint64)å¤§å°å­—æ®µ
            UINT32_LENGTH: 4, // æ–‡ä»¶åé•¿åº¦å­—æ®µä»ä½¿ç”¨4å­—èŠ‚
            CHUNK_SIZE: 1024 * 1024, // 1MB
            MAX_MEMORY_MODE_SIZE: 1024 * 1024 * 1024, // 1GB - å†…å­˜æ¨¡å¼é™åˆ¶
            MAX_FILENAME_LENGTH: 255, // æ–‡ä»¶åé•¿åº¦é™åˆ¶
            PROGRESS_THROTTLE: 100, // è¿›åº¦æ›´æ–°é—´éš”(ms)
            MAX_BLOB_CHUNKS: 10000, // Safariå…¼å®¹æ€§é™åˆ¶
            MIN_V3_FILE_SIZE: 24, // æœ€å°æ–‡ä»¶å¤§å°æ£€æŸ¥
        };

        // ä¸‹è½½Windowsç‰ˆæœ¬çš„å‡½æ•°
        function downloadWindows() {
            // è¿™é‡Œå¯ä»¥æ›¿æ¢ä¸ºå®é™…çš„ä¸‹è½½é“¾æ¥
            const downloadUrl = 'https://github.com/your-repo/releases/latest/download/video-merger-v3-windows.exe';
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = 'video-merger-v3-windows.exe';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            addDebugInfo('å¼€å§‹ä¸‹è½½Windowsç‰ˆæœ¬');
            
            // æ˜¾ç¤ºä¸‹è½½æç¤º
            const downloadSection = document.querySelector('.download-section');
            const originalContent = downloadSection.innerHTML;
            
            downloadSection.innerHTML = `
                <div class="download-title">ğŸ“¥ æ­£åœ¨ä¸‹è½½ Windows ç‰ˆæœ¬...</div>
                <div style="color: #666; font-size: 0.9em; padding: 10px;">
                    å¦‚æœä¸‹è½½æ²¡æœ‰å¼€å§‹ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨çš„ä¸‹è½½è®¾ç½®æˆ–ç›´æ¥è®¿é—®å‘å¸ƒé¡µé¢
                </div>
            `;
            
            // 3ç§’åæ¢å¤åŸæ¥çš„å†…å®¹
            setTimeout(() => {
                downloadSection.innerHTML = originalContent;
            }, 3000);
        }

        // æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹
        const BROWSER_SUPPORT = {
            isSupported: true,
            features: {
                fileAPI: typeof FileReader !== 'undefined',
                streams: typeof ReadableStream !== 'undefined',
                workers: typeof Worker !== 'undefined',
                blob: typeof Blob !== 'undefined',
                bigint: typeof BigInt !== 'undefined'
            },
            browser: detectBrowser(),
            warnings: []
        };

        function detectBrowser() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            if (ua.includes('MSIE') || ua.includes('Trident')) return 'IE';
            return 'Unknown';
        }

        // è°ƒè¯•ä¿¡æ¯ç®¡ç†
        function addDebugInfo(info) {
            if (!devMode) return;
            
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.textContent += `[${timestamp}] ${info}\n`;
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        function clearDebugInfo() {
            document.getElementById('debugContent').textContent = '';
        }

        function toggleDevMode() {
            devMode = document.getElementById('devModeToggle').checked;
            const debugInfo = document.getElementById('debugInfo');
            const statusText = document.getElementById('devModeStatus');
            
            if (devMode) {
                debugInfo.classList.add('show');
                statusText.textContent = 'å¼€å¯';
                addDebugInfo('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼Œå°†æ˜¾ç¤ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯');
            } else {
                debugInfo.classList.remove('show');
                statusText.textContent = 'å…³é—­';
                clearDebugInfo();
            }
        }

        // åˆå§‹åŒ–ç³»ç»Ÿæ£€æµ‹
        function initializeSystem() {
            const systemInfo = document.getElementById('systemInfo');
            const warnings = [];

            // æ£€æµ‹å†…å­˜
            const memory = navigator.deviceMemory || 'unknown';
            const estimatedMemory = memory !== 'unknown' ? `${memory}GB` : 'æœªçŸ¥';

            // æ£€æµ‹æµè§ˆå™¨å…¼å®¹æ€§
            if (BROWSER_SUPPORT.browser === 'Safari') {
                warnings.push('Safariæµè§ˆå™¨å¯¹å¤§æ–‡ä»¶å¤„ç†æœ‰é™åˆ¶ï¼Œå»ºè®®ä½¿ç”¨Chromeæˆ–Firefox');
            }
            if (BROWSER_SUPPORT.browser === 'IE') {
                warnings.push('ä¸æ”¯æŒIEæµè§ˆå™¨ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨');
                BROWSER_SUPPORT.isSupported = false;
            }

            // æ£€æµ‹å¿…è¦çš„API
            if (!BROWSER_SUPPORT.features.fileAPI) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶API');
                BROWSER_SUPPORT.isSupported = false;
            }
            
            if (!BROWSER_SUPPORT.features.bigint) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒBigIntï¼Œå¯èƒ½æ— æ³•å¤„ç†è¶…å¤§æ–‡ä»¶');
            }

            let html = `
                <strong>ğŸ” ç³»ç»Ÿæ£€æµ‹ï¼š</strong>
                æµè§ˆå™¨ï¼š${BROWSER_SUPPORT.browser} | 
                è®¾å¤‡å†…å­˜ï¼š${estimatedMemory} | 
                å…¼å®¹æ€§ï¼š${BROWSER_SUPPORT.isSupported ? 'âœ… è‰¯å¥½' : 'âŒ ä¸æ”¯æŒ'}
            `;

            if (warnings.length > 0) {
                html += `<br><strong>âš ï¸ è­¦å‘Šï¼š</strong>${warnings.join('ï¼›')}`;
                systemInfo.className = 'system-info browser-compatibility warning';
            }

            systemInfo.innerHTML = html;
            
            addDebugInfo(`ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ: æµè§ˆå™¨=${BROWSER_SUPPORT.browser}, å†…å­˜=${estimatedMemory}, BigIntæ”¯æŒ=${BROWSER_SUPPORT.features.bigint}`);
        }

        // æ ¼å¼æ£€æµ‹
        async function isV3MergedFile(file) {
            try {
                addDebugInfo(`æ£€æµ‹æ ¼å¼: æ–‡ä»¶å¤§å°=${file.size}`);
                
                // æ£€æŸ¥æœ€å°æ–‡ä»¶å¤§å°
                if (file.size < CONFIG.MIN_V3_FILE_SIZE) {
                    addDebugInfo(`æ–‡ä»¶å¤ªå°: ${file.size} < ${CONFIG.MIN_V3_FILE_SIZE}`);
                    return false;
                }

                // è¯»å–æœ«å°¾9å­—èŠ‚æ£€æŸ¥é­”æœ¯å­—èŠ‚
                const magicBuffer = await readFileChunk(file, 
                    file.size - CONFIG.MAGIC_LENGTH_V3, file.size);
                const magicBytes = new Uint8Array(magicBuffer);
                
                let isV3 = true;
                for (let i = 0; i < CONFIG.MAGIC_BYTES_V3.length; i++) {
                    if (magicBytes[i] !== CONFIG.MAGIC_BYTES_V3[i]) {
                        isV3 = false;
                        break;
                    }
                }
                
                const magicString = new TextDecoder().decode(magicBytes);
                addDebugInfo(`é­”æœ¯å­—èŠ‚æ£€æµ‹: "${magicString}" vs "MERGEDv3" => ${isV3}`);
                
                return isV3;
            } catch (error) {
                addDebugInfo(`æ ¼å¼æ£€æµ‹å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // æ–‡ä»¶åéªŒè¯å’Œæ¸…ç†
        function validateAndCleanFilename(filename) {
            addDebugInfo(`æ–‡ä»¶åæ¸…ç†å‰: "${filename}"`);
            
            if (!filename || filename.length === 0) {
                throw new Error('æ–‡ä»¶åä¸èƒ½ä¸ºç©º');
            }

            // ç§»é™¤æˆ–æ›¿æ¢éæ³•å­—ç¬¦
            const cleaned = filename
                .replace(/[<>:"/\\|?*\x00-\x1f]/g, '_') // æ›¿æ¢Windowséæ³•å­—ç¬¦
                .replace(/^\.+/, '') // ç§»é™¤å¼€å¤´çš„ç‚¹
                .substring(0, CONFIG.MAX_FILENAME_LENGTH); // é™åˆ¶é•¿åº¦

            if (cleaned.length === 0) {
                throw new Error('æ–‡ä»¶ååŒ…å«è¿‡å¤šéæ³•å­—ç¬¦');
            }
            
            addDebugInfo(`æ–‡ä»¶åæ¸…ç†å: "${cleaned}"`);
            return cleaned;
        }

        // å†…å­˜ä½¿ç”¨ä¼°ç®—
        function estimateMemoryUsage(totalSize, mode) {
            const estimated = mode === 'memory' ? totalSize * 2.5 : Math.min(CONFIG.CHUNK_SIZE * 10, totalSize * 0.1);
            addDebugInfo(`å†…å­˜ä¼°ç®—: æ¨¡å¼=${mode}, æ–‡ä»¶å¤§å°=${totalSize}, é¢„è®¡å†…å­˜=${estimated}`);
            return estimated;
        }

        // è¿›åº¦æ›´æ–°èŠ‚æµ
        let lastProgressUpdate = 0;
        function updateProgress(progressBar, progressDetails, percent, text, details = '') {
            const now = Date.now();
            if (now - lastProgressUpdate < CONFIG.PROGRESS_THROTTLE && percent < 100) {
                return;
            }
            lastProgressUpdate = now;

            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            if (progressDetails) {
                progressDetails.textContent = `${text} ${details}`;
            }
        }

        // å®‰å…¨çš„Blob URLåˆ›å»ºå’Œç®¡ç†
        function createBlobUrl(blob) {
            const url = URL.createObjectURL(blob);
            blobUrls.push(url);
            addDebugInfo(`åˆ›å»ºBlob URL: å¤§å°=${blob.size}, URL=${url.substring(0, 50)}...`);
            return url;
        }

        function cleanupBlobUrls() {
            addDebugInfo(`æ¸…ç†${blobUrls.length}ä¸ªBlob URL`);
            blobUrls.forEach(url => {
                try {
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.warn('Failed to revoke URL:', e);
                }
            });
            blobUrls = [];
        }

        // å»¶è¿Ÿæ¸…ç†URLï¼Œç»™ä¸‹è½½è¶³å¤Ÿæ—¶é—´
        function scheduleCleanup(url, delay = 30000) {
            setTimeout(() => {
                try {
                    URL.revokeObjectURL(url);
                    const index = blobUrls.indexOf(url);
                    if (index > -1) {
                        blobUrls.splice(index, 1);
                    }
                    addDebugInfo(`å»¶è¿Ÿæ¸…ç†Blob URL: ${url.substring(0, 50)}...`);
                } catch (e) {
                    console.warn('Failed to revoke URL:', e);
                }
            }, delay);
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', cleanupBlobUrls);

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');

            // åˆ‡æ¢æ ‡ç­¾æ—¶å–æ¶ˆå½“å‰æ“ä½œ
            cancelOperation();
            addDebugInfo(`åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${tab}`);
        }

        function selectMode(mode) {
            if (document.querySelector(`[data-mode="${mode}"]`).classList.contains('disabled')) {
                return;
            }
            
            processingMode = mode;
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.toggle('active', option.dataset.mode === mode);
            });
            addDebugInfo(`é€‰æ‹©å¤„ç†æ¨¡å¼: ${mode}`);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event, type) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');

            const file = event.dataTransfer.files[0];
            if (file) {
                addDebugInfo(`æ‹–æ‹½æ–‡ä»¶: ç±»å‹=${type}, æ–‡ä»¶å=${file.name}, å¤§å°=${file.size}`);
                if (type === 'video') {
                    handleVideoFile(file);
                } else if (type === 'file') {
                    handleAttachFile(file);
                } else if (type === 'merged') {
                    handleMergedFile(file);
                }
            }
        }

        function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (file) handleVideoFile(file);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) handleAttachFile(file);
        }

        function handleMergedSelect(event) {
            const file = event.target.files[0];
            if (file) handleMergedFile(file);
        }

        function validateFile(file, type) {
            if (!file) {
                throw new Error('æ–‡ä»¶ä¸ºç©º');
            }

            if (file.size === 0) {
                throw new Error('ä¸èƒ½å¤„ç†ç©ºæ–‡ä»¶');
            }

            // æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆæ ¹æ®æµè§ˆå™¨è°ƒæ•´ï¼‰
            const maxSize = BROWSER_SUPPORT.browser === 'Safari' ? 2 * 1024 * 1024 * 1024 : 8 * 1024 * 1024 * 1024; // Safari 2GB, å…¶ä»– 8GB
            if (file.size > maxSize) {
                throw new Error(`æ–‡ä»¶è¿‡å¤§ï¼Œè¶…è¿‡ ${formatFileSize(maxSize)} é™åˆ¶`);
            }

            addDebugInfo(`æ–‡ä»¶éªŒè¯é€šè¿‡: ç±»å‹=${type}, å¤§å°=${file.size}`);
            return true;
        }

        function handleVideoFile(file) {
            try {
                validateFile(file, 'video');
                videoFile = file;
                
                const info = document.getElementById('videoInfo');
                const ext = getFileExtension(file.name);
                
                let warningHtml = '';
                const formatWarnings = {
                    'mov': 'MOVæ ¼å¼å°è£…ä¸¥æ ¼ï¼Œåˆå¹¶åå¯èƒ½æ— æ³•æ’­æ”¾ã€‚å»ºè®®è½¬æ¢ä¸ºMP4æ ¼å¼ã€‚',
                    'wmv': 'WMVæ ¼å¼å¯èƒ½ä¸å…¼å®¹ï¼Œå»ºè®®ä½¿ç”¨MP4æˆ–MKVæ ¼å¼ã€‚',
                    'flv': 'FLVæ ¼å¼ä¸æ¨èä½¿ç”¨ï¼Œå¾ˆå¯èƒ½æ— æ³•æ­£å¸¸æ’­æ”¾ã€‚'
                };
                
                if (formatWarnings[ext]) {
                    warningHtml = `<div class="warning"><strong>âš ï¸ æ ¼å¼è­¦å‘Šï¼š</strong>${formatWarnings[ext]}</div>`;
                }

                info.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">ğŸ¥</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    ${warningHtml}
                `;
                info.style.display = 'block';
                checkMergeReady();
                
                addDebugInfo(`è§†é¢‘æ–‡ä»¶é€‰æ‹©: ${file.name}, ${file.size}å­—èŠ‚`);
            } catch (error) {
                showError('è§†é¢‘æ–‡ä»¶é”™è¯¯', error.message);
            }
        }

        function handleAttachFile(file) {
            try {
                validateFile(file, 'attach');
                
                // éªŒè¯æ–‡ä»¶å
                validateAndCleanFilename(file.name);
                
                attachFile = file;
                const info = document.getElementById('fileInfo');
                
                let filenameWarning = '';
                if (file.name.length > 200) {
                    filenameWarning = '<div class="filename-warning">âš ï¸ æ–‡ä»¶åè¾ƒé•¿ï¼Œå°†è‡ªåŠ¨æˆªæ–­</div>';
                }

                info.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    ${filenameWarning}
                `;
                info.style.display = 'block';
                checkMergeReady();
                
                addDebugInfo(`é™„åŠ æ–‡ä»¶é€‰æ‹©: ${file.name}, ${file.size}å­—èŠ‚`);
            } catch (error) {
                showError('é™„åŠ æ–‡ä»¶é”™è¯¯', error.message);
            }
        }

        async function handleMergedFile(file) {
            try {
                validateFile(file, 'merged');
                mergedFile = file;
                
                // æ£€æµ‹æ˜¯å¦ä¸ºæ ¼å¼
                const isV3 = await isV3MergedFile(file);
                
                const info = document.getElementById('mergedInfo');
                let formatInfo = '';
                if (isV3) {
                    formatInfo = '<div style="color: #2e7d32; font-size: 0.9em;">âœ… æ£€æµ‹åˆ°æ ¼å¼æ–‡ä»¶</div>';
                } else {
                    formatInfo = '<div style="color: #f57c00; font-size: 0.9em;">âš ï¸ æœªæ£€æµ‹åˆ°æ ¼å¼ï¼Œå»ºè®®å¯ç”¨å¼€å‘æ¨¡å¼æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>';
                }
                
                info.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">ğŸ“¦</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    ${formatInfo}
                `;
                info.style.display = 'block';
                document.getElementById('splitBtn').style.display = 'inline-block';
                
                addDebugInfo(`åˆå¹¶æ–‡ä»¶é€‰æ‹©: ${file.name}, ${file.size}å­—èŠ‚, æ ¼å¼=${isV3}`);
            } catch (error) {
                showError('åˆå¹¶æ–‡ä»¶é”™è¯¯', error.message);
            }
        }

        function checkMergeReady() {
            if (videoFile && attachFile) {
                const totalSize = videoFile.size + attachFile.size;
                const processingModeEl = document.getElementById('processingMode');
                const memoryWarning = document.getElementById('memoryWarning');
                
                processingModeEl.style.display = 'flex';

                // æ ¹æ®æ–‡ä»¶å¤§å°å’Œç³»ç»Ÿå†…å­˜æ™ºèƒ½æ¨èæ¨¡å¼
                const estimatedMemory = estimateMemoryUsage(totalSize, 'memory');
                const deviceMemory = (navigator.deviceMemory || 4) * 1024 * 1024 * 1024; // é»˜è®¤4GB
                
                let warningHtml = '';
                
                if (totalSize > CONFIG.MAX_MEMORY_MODE_SIZE || estimatedMemory > deviceMemory * 0.5) {
                    // ç¦ç”¨å†…å­˜æ¨¡å¼
                    document.querySelector('[data-mode="memory"]').classList.add('disabled');
                    selectMode('stream');
                    warningHtml = `
                        <strong>âš ï¸ è‡ªåŠ¨é€‰æ‹©æµå¼æ¨¡å¼ï¼š</strong><br>
                        æ–‡ä»¶æ€»å¤§å°ï¼š${formatFileSize(totalSize)}<br>
                        é¢„è®¡å†…å­˜éœ€æ±‚ï¼š${formatFileSize(estimatedMemory)}<br>
                        è¶…è¿‡å†…å­˜æ¨¡å¼é™åˆ¶ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢ä¸ºæµå¼æ¨¡å¼ä»¥ç¡®ä¿ç¨³å®šæ€§
                    `;
                } else {
                    warningHtml = `
                        <strong>ğŸ’¡ å¤„ç†ä¿¡æ¯ï¼š</strong><br>
                        æ–‡ä»¶æ€»å¤§å°ï¼š${formatFileSize(totalSize)}<br>
                        é¢„è®¡å†…å­˜éœ€æ±‚ï¼š${formatFileSize(estimatedMemory)}<br>
                        æ¨èä½¿ç”¨${totalSize > 100 * 1024 * 1024 ? 'æµå¼' : 'å†…å­˜'}æ¨¡å¼
                    `;
                }

                memoryWarning.innerHTML = warningHtml;
                memoryWarning.style.display = 'block';
                
                document.getElementById('mergeBtn').style.display = 'inline-block';
                
                addDebugInfo(`åˆå¹¶å‡†å¤‡å°±ç»ª: æ€»å¤§å°=${totalSize}, æ¨èæ¨¡å¼=${processingMode}`);
            }
        }

        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showError(title, message) {
            const activeTab = document.querySelector('.content.active').id;
            const resultEl = document.getElementById(activeTab === 'merge' ? 'mergeResult' : 'splitResult');
            
            resultEl.innerHTML = `<h3>âŒ ${title}</h3><p>${message}</p>`;
            resultEl.className = 'result error';
            resultEl.style.display = 'block';
            
            addDebugInfo(`é”™è¯¯: ${title} - ${message}`);
        }

        function cancelOperation() {
            if (currentOperation) {
                currentOperation.cancelled = true;
                currentOperation = null;
                addDebugInfo('ç”¨æˆ·å–æ¶ˆæ“ä½œ');
            }
            
            // éšè—è¿›åº¦æ¡å’Œå–æ¶ˆæŒ‰é’®
            document.getElementById('mergeProgress').style.display = 'none';
            document.getElementById('splitProgress').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('splitCancelBtn').style.display = 'none';
            
            // å¯ç”¨æ“ä½œæŒ‰é’®
            document.getElementById('mergeBtn').disabled = false;
            document.getElementById('splitBtn').disabled = false;
        }

        async function mergeFiles() {
            if (processingMode === 'memory') {
                await mergeFilesMemory();
            } else {
                await mergeFilesStream();
            }
        }

        // æ ¼å¼åˆå¹¶å‡½æ•°ï¼ˆå†…å­˜æ¨¡å¼ï¼‰
        async function mergeFilesMemory() {
            const progressEl = document.getElementById('mergeProgress');
            const progressBar = document.getElementById('mergeProgressBar');
            const progressDetails = document.getElementById('mergeProgressDetails');
            const resultEl = document.getElementById('mergeResult');
            const mergeBtn = document.getElementById('mergeBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            currentOperation = { cancelled: false };
            mergeBtn.disabled = true;
            cancelBtn.style.display = 'inline-block';
            progressEl.style.display = 'block';
            resultEl.style.display = 'none';

            try {
                addDebugInfo('å¼€å§‹å†…å­˜æ¨¡å¼åˆå¹¶');
                
                // æ¸…ç†æ–‡ä»¶å
                const cleanedAttachName = validateAndCleanFilename(attachFile.name);

                updateProgress(progressBar, progressDetails, 5, 'å¼€å§‹å¤„ç†...', 'å‡†å¤‡è¯»å–æ–‡ä»¶');
                
                if (currentOperation.cancelled) throw new Error('æ“ä½œå·²å–æ¶ˆ');

                // è¯»å–è§†é¢‘æ–‡ä»¶
                addDebugInfo(`è¯»å–è§†é¢‘æ–‡ä»¶: ${videoFile.size}å­—èŠ‚`);
                updateProgress(progressBar, progressDetails, 10, 'è¯»å–è§†é¢‘æ–‡ä»¶...', formatFileSize(0));
                const videoBuffer = await readFileAsArrayBuffer(videoFile);
                
                if (currentOperation.cancelled) throw new Error('æ“ä½œå·²å–æ¶ˆ');

                addDebugInfo(`è¯»å–é™„åŠ æ–‡ä»¶: ${attachFile.size}å­—èŠ‚`);
                updateProgress(progressBar, progressDetails, 40, 'è¯»å–é™„åŠ æ–‡ä»¶...', formatFileSize(videoFile.size));
                const attachBuffer = await readFileAsArrayBuffer(attachFile);
                
                if (currentOperation.cancelled) throw new Error('æ“ä½œå·²å–æ¶ˆ');

                updateProgress(progressBar, progressDetails, 70, 'åˆ›å»ºæ ¼å¼...', 'åˆå¹¶æ•°æ®');

                const encoder = new TextEncoder();
                const attachNameBytes = encoder.encode(cleanedAttachName);

                // è®¡ç®—æ€»å¤§å°
                const metadataSize = CONFIG.UINT32_LENGTH + attachNameBytes.length + CONFIG.SIZE_LENGTH + CONFIG.SIZE_LENGTH + CONFIG.MAGIC_LENGTH_V3;
                const totalSize = videoBuffer.byteLength + attachBuffer.byteLength + metadataSize;

                addDebugInfo(`æ ¼å¼è®¡ç®—: è§†é¢‘=${videoBuffer.byteLength}, é™„åŠ =${attachBuffer.byteLength}, å…ƒæ•°æ®=${metadataSize}, æ€»è®¡=${totalSize}`);

                const mergedArray = new Uint8Array(totalSize);
                let offset = 0;

                // 1. å†™å…¥è§†é¢‘æ–‡ä»¶å†…å®¹
                mergedArray.set(new Uint8Array(videoBuffer), offset);
                offset += videoBuffer.byteLength;

                // 2. å†™å…¥é™„åŠ æ–‡ä»¶å†…å®¹
                mergedArray.set(new Uint8Array(attachBuffer), offset);
                offset += attachBuffer.byteLength;

                // 3. å†™å…¥æ–‡ä»¶åé•¿åº¦ï¼ˆ4å­—èŠ‚ï¼Œå°ç«¯åºï¼‰
                const nameLengthView = new DataView(new ArrayBuffer(CONFIG.UINT32_LENGTH));
                nameLengthView.setUint32(0, attachNameBytes.length, true);
                mergedArray.set(new Uint8Array(nameLengthView.buffer), offset);
                offset += CONFIG.UINT32_LENGTH;

                // 4. å†™å…¥æ–‡ä»¶å
                mergedArray.set(attachNameBytes, offset);
                offset += attachNameBytes.length;

                // 5. å†™å…¥è§†é¢‘å¤§å°ï¼ˆ8å­—èŠ‚ï¼Œå°ç«¯åºï¼‰
                const videoSizeView = new DataView(new ArrayBuffer(CONFIG.SIZE_LENGTH));
                videoSizeView.setBigUint64(0, BigInt(videoBuffer.byteLength), true);
                mergedArray.set(new Uint8Array(videoSizeView.buffer), offset);
                offset += CONFIG.SIZE_LENGTH;

                // 6. å†™å…¥é™„åŠ æ–‡ä»¶å¤§å°ï¼ˆ8å­—èŠ‚ï¼Œå°ç«¯åºï¼‰
                const attachSizeView = new DataView(new ArrayBuffer(CONFIG.SIZE_LENGTH));
                attachSizeView.setBigUint64(0, BigInt(attachBuffer.byteLength), true);
                mergedArray.set(new Uint8Array(attachSizeView.buffer), offset);
                offset += CONFIG.SIZE_LENGTH;

                // 7. å†™å…¥é­”æœ¯å­—èŠ‚ "MERGEDv3"
                mergedArray.set(CONFIG.MAGIC_BYTES_V3, offset);

                addDebugInfo(`æ ¼å¼å†™å…¥å®Œæˆ: æœ€ç»ˆåç§»=${offset}, æœŸæœ›=${totalSize}`);

                if (currentOperation.cancelled) throw new Error('æ“ä½œå·²å–æ¶ˆ');

                updateProgress(progressBar, progressDetails, 95, 'ç”Ÿæˆä¸‹è½½æ–‡ä»¶...', 'åˆ›å»ºè¾“å‡º');

                const blob = new Blob([mergedArray], { type: 'application/octet-stream' });
                const url = createBlobUrl(blob);

                const outputName = videoFile.name.replace(/\.[^/.]+$/, '') + '_merged_v3' +
                                 videoFile.name.substring(videoFile.name.lastIndexOf('.'));

                updateProgress(progressBar, progressDetails, 100, 'å®Œæˆï¼', '');

                // å®‰æ’30ç§’åæ¸…ç†URLï¼Œç»™ä¸‹è½½è¶³å¤Ÿæ—¶é—´
                scheduleCleanup(url, 30000);

                resultEl.innerHTML = `
                    <h3>âœ… æ ¼å¼åˆå¹¶å®Œæˆï¼</h3>
                    <p>è§†é¢‘å¤§å°ï¼š${formatFileSize(videoBuffer.byteLength)}</p>
                    <p>é™„åŠ æ–‡ä»¶ï¼š${cleanedAttachName} (${formatFileSize(attachBuffer.byteLength)})</p>
                    <p>åˆå¹¶åå¤§å°ï¼š${formatFileSize(totalSize)}</p>
                    <div style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                        <a href="${url}" download="${outputName}" class="button">ğŸ“¥ ä¸‹è½½åˆå¹¶æ–‡ä»¶</a>
                        <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                            ğŸ’¡ ä¸‹è½½æç¤ºï¼šå¦‚æœä¸‹è½½æ²¡æœ‰å¼€å§‹ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨çš„ä¸‹è½½è®¾ç½®æˆ–å¼¹çª—æ‹¦æˆªå™¨
                        </p>
                    </div>
                `;
                resultEl.className = 'result';
                resultEl.style.display = 'block';

                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 1000);

                addDebugInfo('å†…å­˜æ¨¡å¼åˆå¹¶æˆåŠŸå®Œæˆ');

            } catch (error) {
                if (error.message !== 'æ“ä½œå·²å–æ¶ˆ') {
                    showError('åˆå¹¶å¤±è´¥', error.message);
                }
            } finally {
                mergeBtn.disabled = false;
                cancelBtn.style.display = 'none';
                currentOperation = null;
            }
        }

        // æ ¼å¼åˆå¹¶å‡½æ•°ï¼ˆæµå¼æ¨¡å¼ï¼‰
        async function mergeFilesStream() {
            const progressEl = document.getElementById('mergeProgress');
            const progressBar = document.getElementById('mergeProgressBar');
            const progressDetails = document.getElementById('mergeProgressDetails');
            const resultEl = document.getElementById('mergeResult');
            const mergeBtn = document.getElementById('mergeBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            currentOperation = { cancelled: false };
            mergeBtn.disabled = true;
            cancelBtn.style.display = 'inline-block';
            progressEl.style.display = 'block';
            resultEl.style.display = 'none';

            try {
                addDebugInfo('å¼€å§‹æµå¼æ¨¡å¼åˆå¹¶');
                
                const cleanedAttachName = validateAndCleanFilename(attachFile.name);
                const encoder = new TextEncoder();
                const attachNameBytes = encoder.encode(cleanedAttachName);

                updateProgress(progressBar, progressDetails, 5, 'åˆå§‹åŒ–æµå¼å¤„ç†...', '');

                const chunks = [];
                let processedSize = 0;
                
                // è®¡ç®—å…ƒæ•°æ®å¤§å°
                const metadataSize = CONFIG.UINT32_LENGTH + attachNameBytes.length + CONFIG.SIZE_LENGTH + CONFIG.SIZE_LENGTH + CONFIG.MAGIC_LENGTH_V3;
                const totalSize = videoFile.size + attachFile.size + metadataSize;

                addDebugInfo(`æµå¼å¤„ç†: æ€»å¤§å°=${totalSize}, å…ƒæ•°æ®=${metadataSize}`);

                // é™åˆ¶åˆ†å—æ•°é‡ä»¥å…¼å®¹Safari
                const actualChunkSize = Math.max(CONFIG.CHUNK_SIZE, 
                    Math.ceil(totalSize / CONFIG.MAX_BLOB_CHUNKS));

                // å¤„ç†è§†é¢‘æ–‡ä»¶
                updateProgress(progressBar, progressDetails, 10, 'æµå¼å¤„ç†è§†é¢‘...', '');
                for (let i = 0; i < videoFile.size; i += actualChunkSize) {
                    if (currentOperation.cancelled) throw new Error('æ“ä½œå·²å–æ¶ˆ');
                    
                    const chunk = await readFileChunk(videoFile, i, Math.min(i + actualChunkSize, videoFile.size));
                    chunks.push(chunk);
                    processedSize += chunk.byteLength;

                    const progress = 10 + Math.round((processedSize / totalSize) * 40);
                    updateProgress(progressBar, progressDetails, progress, 'å¤„ç†è§†é¢‘...', 
                        `${formatFileSize(processedSize)} / ${formatFileSize(totalSize)}`);
                }

                // å¤„ç†é™„åŠ æ–‡ä»¶
                updateProgress(progressBar, progressDetails, 55, 'æµå¼å¤„ç†é™„åŠ æ–‡ä»¶...', '');
                for (let i = 0; i < attachFile.size; i += actualChunkSize) {
                    if (currentOperation.cancelled) throw new Error('æ“ä½œå·²å–æ¶ˆ');
                    
                    const chunk = await readFileChunk(attachFile, i, Math.min(i + actualChunkSize, attachFile.size));
                    chunks.push(chunk);
                    processedSize += chunk.byteLength;

                    const progress = 55 + Math.round(((processedSize - videoFile.size) / attachFile.size) * 25);
                    updateProgress(progressBar, progressDetails, progress, 'å¤„ç†é™„åŠ æ–‡ä»¶...', 
                        `${formatFileSize(processedSize)} / ${formatFileSize(totalSize)}`);
                }

                // åˆ›å»ºæ ¼å¼å…ƒæ•°æ®
                updateProgress(progressBar, progressDetails, 85, 'åˆ›å»ºå…ƒæ•°æ®...', '');
                const metadata = new Uint8Array(metadataSize);
                let metaOffset = 0;

                // æ–‡ä»¶åé•¿åº¦(4å­—èŠ‚)
                const nameLengthView = new DataView(new ArrayBuffer(CONFIG.UINT32_LENGTH));
                nameLengthView.setUint32(0, attachNameBytes.length, true);
                metadata.set(new Uint8Array(nameLengthView.buffer), metaOffset);
                metaOffset += CONFIG.UINT32_LENGTH;

                // æ–‡ä»¶å
                metadata.set(attachNameBytes, metaOffset);
                metaOffset += attachNameBytes.length;

                // è§†é¢‘å¤§å°(8å­—èŠ‚)
                const videoSizeView = new DataView(new ArrayBuffer(CONFIG.SIZE_LENGTH));
                videoSizeView.setBigUint64(0, BigInt(videoFile.size), true);
                metadata.set(new Uint8Array(videoSizeView.buffer), metaOffset);
                metaOffset += CONFIG.SIZE_LENGTH;

                // é™„åŠ æ–‡ä»¶å¤§å°(8å­—èŠ‚)
                const attachSizeView = new DataView(new ArrayBuffer(CONFIG.SIZE_LENGTH));
                attachSizeView.setBigUint64(0, BigInt(attachFile.size), true);
                metadata.set(new Uint8Array(attachSizeView.buffer), metaOffset);
                metaOffset += CONFIG.SIZE_LENGTH;

                // é­”æœ¯å­—èŠ‚
                metadata.set(CONFIG.MAGIC_BYTES_V3, metaOffset);

                chunks.push(metadata);
                processedSize += metadata.byteLength;

                addDebugInfo(`æµå¼å…ƒæ•°æ®åˆ›å»ºå®Œæˆ: åˆ†å—æ•°=${chunks.length}, å…ƒæ•°æ®å¤§å°=${metadata.byteLength}`);

                updateProgress(progressBar, progressDetails, 95, 'ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶...', '');

                const blob = new Blob(chunks, { type: 'application/octet-stream' });
                const url = createBlobUrl(blob);

                const outputName = videoFile.name.replace(/\.[^/.]+$/, '') + '_merged_v3' +
                                 videoFile.name.substring(videoFile.name.lastIndexOf('.'));

                updateProgress(progressBar, progressDetails, 100, 'å®Œæˆï¼', '');

                // å®‰æ’30ç§’åæ¸…ç†URLï¼Œç»™ä¸‹è½½è¶³å¤Ÿæ—¶é—´
                scheduleCleanup(url, 30000);

                resultEl.innerHTML = `
                    <h3>âœ… æµå¼åˆå¹¶å®Œæˆï¼</h3>
                    <p>è§†é¢‘å¤§å°ï¼š${formatFileSize(videoFile.size)}</p>
                    <p>é™„åŠ æ–‡ä»¶ï¼š${cleanedAttachName} (${formatFileSize(attachFile.size)})</p>
                    <p>åˆå¹¶åå¤§å°ï¼š${formatFileSize(totalSize)}</p>
                    <div style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                        <a href="${url}" download="${outputName}" class="button">ğŸ“¥ ä¸‹è½½åˆå¹¶æ–‡ä»¶</a>
                        <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                            ğŸ’¡ ä¸‹è½½æç¤ºï¼šå¦‚æœä¸‹è½½æ²¡æœ‰å¼€å§‹ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨çš„ä¸‹è½½è®¾ç½®æˆ–å¼¹çª—æ‹¦æˆªå™¨
                        </p>
                    </div>
                `;
                resultEl.className = 'result';
                resultEl.style.display = 'block';

                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 1000);

                addDebugInfo('æµå¼æ¨¡å¼åˆå¹¶æˆåŠŸå®Œæˆ');

            } catch (error) {
                if (error.message !== 'æ“ä½œå·²å–æ¶ˆ') {
                    showError('æµå¼åˆå¹¶å¤±è´¥', error.message);
                }
            } finally {
                mergeBtn.disabled = false;
                cancelBtn.style.display = 'none';
                currentOperation = null;
            }
        }

        function readFileChunk(file, start, end) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file.slice(start, end));
            });
        }

        // æ ¼å¼æ‹†åˆ†å‡½æ•°
        async function splitFiles() {
            const progressEl = document.getElementById('splitProgress');
            const progressBar = document.getElementById('splitProgressBar');
            const progressDetails = document.getElementById('splitProgressDetails');
            const resultEl = document.getElementById('splitResult');
            const splitBtn = document.getElementById('splitBtn');
            const cancelBtn = document.getElementById('splitCancelBtn');

            currentOperation = { cancelled: false };
            splitBtn.disabled = true;
            cancelBtn.style.display = 'inline-block';
            progressEl.style.display = 'block';
            resultEl.style.display = 'none';

            // è°ƒè¯•ä¿¡æ¯æ”¶é›†
            let debugData = {
                fileSize: mergedFile.size,
                magicBytes: '',
                videoSize: 0,
                attachSize: 0,
                filenameLength: 0,
                filename: '',
                positions: {},
                errors: []
            };

            try {
                addDebugInfo('å¼€å§‹æ ¼å¼æ‹†åˆ†');
                debugData.fileSize = mergedFile.size;

                updateProgress(progressBar, progressDetails, 5, 'æ ¼å¼è§£æ...', '');

                const fileSize = mergedFile.size;

                // 1. æ£€æŸ¥æœ€å°æ–‡ä»¶å¤§å°
                if (fileSize < CONFIG.MIN_V3_FILE_SIZE) {
                    const error = `æ–‡ä»¶å¤ªå°: ${fileSize} < ${CONFIG.MIN_V3_FILE_SIZE}`;
                    debugData.errors.push(error);
                    throw new Error(error);
                }

                updateProgress(progressBar, progressDetails, 15, 'å›ºå®šä½ç½®è¯»å–...', '');

                // 2. è¯»å–é­”æœ¯å­—èŠ‚ï¼ˆæœ«å°¾9å­—èŠ‚ï¼‰
                debugData.positions.magicBytes = fileSize - CONFIG.MAGIC_LENGTH_V3;
                const magicBuffer = await readFileChunk(mergedFile, 
                    fileSize - CONFIG.MAGIC_LENGTH_V3, fileSize);
                const magicBytes = new Uint8Array(magicBuffer);
                debugData.magicBytes = new TextDecoder().decode(magicBytes);

                addDebugInfo(`é­”æœ¯å­—èŠ‚ä½ç½®: ${debugData.positions.magicBytes}, å†…å®¹: "${debugData.magicBytes}"`);

                // éªŒè¯é­”æœ¯å­—èŠ‚
                let isValidMagic = true;
                for (let i = 0; i < CONFIG.MAGIC_BYTES_V3.length; i++) {
                    if (magicBytes[i] !== CONFIG.MAGIC_BYTES_V3[i]) {
                        isValidMagic = false;
                        break;
                    }
                }

                if (!isValidMagic) {
                    const error = `é­”æœ¯å­—èŠ‚éªŒè¯å¤±è´¥: æœŸæœ›"MERGEDv3", å®é™…"${debugData.magicBytes}"`;
                    debugData.errors.push(error);
                    // åœ¨å¼€å‘æ¨¡å¼ä¸‹ç»§ç»­å°è¯•è§£æ
                    if (!devMode) {
                        throw new Error(error);
                    }
                    addDebugInfo('å¼€å‘æ¨¡å¼ï¼šå¿½ç•¥é­”æœ¯å­—èŠ‚é”™è¯¯ï¼Œç»§ç»­è§£æ');
                }

                updateProgress(progressBar, progressDetails, 30, 'è¯»å–æ–‡ä»¶å¤§å°...', '');

                // 3. è¯»å–é™„åŠ æ–‡ä»¶å¤§å°ï¼ˆæœ«å°¾-17åˆ°æœ«å°¾-9ï¼Œ8å­—èŠ‚ï¼‰
                debugData.positions.attachSize = fileSize - CONFIG.MAGIC_LENGTH_V3 - CONFIG.SIZE_LENGTH;
                const attachSizeBuffer = await readFileChunk(mergedFile, 
                    debugData.positions.attachSize, 
                    fileSize - CONFIG.MAGIC_LENGTH_V3);
                const attachSizeView = new DataView(attachSizeBuffer);
                debugData.attachSize = Number(attachSizeView.getBigUint64(0, true));

                addDebugInfo(`é™„åŠ æ–‡ä»¶å¤§å°ä½ç½®: ${debugData.positions.attachSize}, å¤§å°: ${debugData.attachSize}`);

                // 4. è¯»å–è§†é¢‘å¤§å°ï¼ˆæœ«å°¾-25åˆ°æœ«å°¾-17ï¼Œ8å­—èŠ‚ï¼‰
                debugData.positions.videoSize = fileSize - CONFIG.MAGIC_LENGTH_V3 - CONFIG.SIZE_LENGTH * 2;
                const videoSizeBuffer = await readFileChunk(mergedFile, 
                    debugData.positions.videoSize, 
                    fileSize - CONFIG.MAGIC_LENGTH_V3 - CONFIG.SIZE_LENGTH);
                const videoSizeView = new DataView(videoSizeBuffer);
                debugData.videoSize = Number(videoSizeView.getBigUint64(0, true));

                addDebugInfo(`è§†é¢‘æ–‡ä»¶å¤§å°ä½ç½®: ${debugData.positions.videoSize}, å¤§å°: ${debugData.videoSize}`);

                updateProgress(progressBar, progressDetails, 50, 'éªŒè¯æ•°æ®...', '');

                // 5. éªŒè¯å¤§å°çš„åˆç†æ€§
                if (debugData.videoSize <= 0 || debugData.videoSize >= fileSize) {
                    const error = `è§†é¢‘æ–‡ä»¶å¤§å°å¼‚å¸¸: ${debugData.videoSize}`;
                    debugData.errors.push(error);
                    if (!devMode) {
                        throw new Error(error);
                    }
                    addDebugInfo('å¼€å‘æ¨¡å¼ï¼šå¿½ç•¥è§†é¢‘å¤§å°é”™è¯¯ï¼Œç»§ç»­è§£æ');
                }

                if (debugData.attachSize <= 0 || debugData.attachSize >= fileSize) {
                    const error = `é™„åŠ æ–‡ä»¶å¤§å°å¼‚å¸¸: ${debugData.attachSize}`;
                    debugData.errors.push(error);
                    if (!devMode) {
                        throw new Error(error);
                    }
                    addDebugInfo('å¼€å‘æ¨¡å¼ï¼šå¿½ç•¥é™„åŠ æ–‡ä»¶å¤§å°é”™è¯¯ï¼Œç»§ç»­è§£æ');
                }

                updateProgress(progressBar, progressDetails, 65, 'è¯»å–æ–‡ä»¶å...', '');

                // 6. è®¡ç®—å¹¶è¯»å–æ–‡ä»¶å
                debugData.positions.metadataStart = debugData.videoSize + debugData.attachSize;
                
                addDebugInfo(`å…ƒæ•°æ®å¼€å§‹ä½ç½®: ${debugData.positions.metadataStart}`);

                // è¯»å–æ–‡ä»¶åé•¿åº¦ï¼ˆ4å­—èŠ‚ï¼‰
                const nameLengthBuffer = await readFileChunk(mergedFile, 
                    debugData.positions.metadataStart, 
                    debugData.positions.metadataStart + CONFIG.UINT32_LENGTH);
                const nameLengthView = new DataView(nameLengthBuffer);
                debugData.filenameLength = nameLengthView.getUint32(0, true);

                addDebugInfo(`æ–‡ä»¶åé•¿åº¦: ${debugData.filenameLength}`);

                // éªŒè¯æ–‡ä»¶åé•¿åº¦
                if (debugData.filenameLength <= 0 || debugData.filenameLength > CONFIG.MAX_FILENAME_LENGTH) {
                    const error = `æ–‡ä»¶åé•¿åº¦å¼‚å¸¸: ${debugData.filenameLength}`;
                    debugData.errors.push(error);
                    if (!devMode) {
                        throw new Error(error);
                    }
                    addDebugInfo('å¼€å‘æ¨¡å¼ï¼šå¿½ç•¥æ–‡ä»¶åé•¿åº¦é”™è¯¯ï¼Œç»§ç»­è§£æ');
                }

                // è¯»å–æ–‡ä»¶å
                if (debugData.filenameLength > 0 && debugData.filenameLength <= CONFIG.MAX_FILENAME_LENGTH) {
                    const nameBuffer = await readFileChunk(mergedFile, 
                        debugData.positions.metadataStart + CONFIG.UINT32_LENGTH, 
                        debugData.positions.metadataStart + CONFIG.UINT32_LENGTH + debugData.filenameLength);
                    debugData.filename = new TextDecoder().decode(nameBuffer);
                    addDebugInfo(`æ–‡ä»¶å: "${debugData.filename}"`);
                } else {
                    debugData.filename = 'unknown_file.bin';
                    addDebugInfo('ä½¿ç”¨é»˜è®¤æ–‡ä»¶å');
                }

                updateProgress(progressBar, progressDetails, 80, 'éªŒè¯æ–‡ä»¶ç»“æ„...', '');

                // 7. éªŒè¯æ€»ä½“æ–‡ä»¶ç»“æ„
                const expectedFileSize = debugData.videoSize + debugData.attachSize + 
                                       CONFIG.UINT32_LENGTH + debugData.filenameLength + 
                                       CONFIG.SIZE_LENGTH * 2 + CONFIG.MAGIC_LENGTH_V3;
                
                addDebugInfo(`æ–‡ä»¶å¤§å°éªŒè¯: æœŸæœ›=${expectedFileSize}, å®é™…=${fileSize}`);

                if (expectedFileSize !== fileSize) {
                    const error = `æ–‡ä»¶ç»“æ„éªŒè¯å¤±è´¥: æœŸæœ›${expectedFileSize}, å®é™…${fileSize}`;
                    debugData.errors.push(error);
                    if (!devMode) {
                        throw new Error(error);
                    }
                    addDebugInfo('å¼€å‘æ¨¡å¼ï¼šå¿½ç•¥æ–‡ä»¶ç»“æ„é”™è¯¯ï¼Œç»§ç»­è§£æ');
                }

                if (currentOperation.cancelled) throw new Error('æ“ä½œå·²å–æ¶ˆ');

                updateProgress(progressBar, progressDetails, 90, 'åˆ›å»ºæå–æ–‡ä»¶...', '');

                // åˆ›å»ºæ–‡ä»¶Blobï¼ˆå³ä½¿åœ¨é”™è¯¯æƒ…å†µä¸‹ä¹Ÿå°è¯•åˆ›å»ºï¼‰
                let videoBlob, attachBlob, videoUrl, attachUrl;
                
                try {
                    videoBlob = mergedFile.slice(0, debugData.videoSize);
                    attachBlob = mergedFile.slice(debugData.videoSize, debugData.videoSize + debugData.attachSize);
                    
                    videoUrl = createBlobUrl(videoBlob);
                    attachUrl = createBlobUrl(attachBlob);
                    
                    scheduleCleanup(videoUrl, 30000);
                    scheduleCleanup(attachUrl, 30000);
                } catch (e) {
                    debugData.errors.push(`åˆ›å»ºBlobå¤±è´¥: ${e.message}`);
                    addDebugInfo(`åˆ›å»ºBlobå¤±è´¥: ${e.message}`);
                }

                updateProgress(progressBar, progressDetails, 100, 'å®Œæˆï¼', '');

                const videoName = mergedFile.name.replace('_merged_v3', '').replace('_merged', '') || 'video.mp4';

                // æ˜¾ç¤ºç»“æœï¼ˆåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼‰
                let resultHtml = '';
                
                if (debugData.errors.length === 0) {
                    // æˆåŠŸæƒ…å†µ
                    resultHtml = `
                        <h3>âœ… æ ¼å¼æ‹†åˆ†æˆåŠŸï¼</h3>
                        <p>âœ“ æ ¼å¼éªŒè¯é€šè¿‡ï¼Œå›ºå®šä½ç½®è¯»å–å®Œæˆ</p>
                        <p>æ‰¾åˆ° 2 ä¸ªæ–‡ä»¶ï¼š</p>
                        <div style="margin-top: 15px;">
                            <div style="margin: 15px 0; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                                <p><strong>è§†é¢‘æ–‡ä»¶ï¼š</strong>${formatFileSize(debugData.videoSize)}</p>
                                <a href="${videoUrl}" download="${videoName}" class="button">ğŸ“¥ ä¸‹è½½è§†é¢‘</a>
                            </div>
                            
                            <div style="margin: 15px 0; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                                <p><strong>éšè—æ–‡ä»¶ï¼š</strong>${debugData.filename} (${formatFileSize(debugData.attachSize)})</p>
                                <a href="${attachUrl}" download="${debugData.filename}" class="button">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</a>
                            </div>
                        </div>
                    `;
                } else {
                    // é”™è¯¯æƒ…å†µï¼ˆå¼€å‘æ¨¡å¼ä¸‹ä»ç„¶å°è¯•æä¾›ä¸‹è½½ï¼‰
                    resultHtml = `
                        <h3>âš ï¸ æ ¼å¼è§£æé‡åˆ°é—®é¢˜</h3>
                        <p>å‘ç° ${debugData.errors.length} ä¸ªé—®é¢˜ï¼Œä½†å·²å°è¯•æå–æ–‡ä»¶ï¼š</p>
                        <ul style="margin: 10px 0; color: #d32f2f;">
                            ${debugData.errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    `;
                    
                    if (videoUrl && attachUrl) {
                        resultHtml += `
                            <div style="margin-top: 15px;">
                                <p style="color: #f57c00;"><strong>âš ï¸ å°è¯•æ€§æå–ï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰ï¼š</strong></p>
                                <div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-radius: 8px;">
                                    <p><strong>è§†é¢‘æ–‡ä»¶ï¼š</strong>${formatFileSize(debugData.videoSize)}</p>
                                    <a href="${videoUrl}" download="${videoName}" class="button secondary">ğŸ“¥ å°è¯•ä¸‹è½½è§†é¢‘</a>
                                </div>
                                
                                <div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-radius: 8px;">
                                    <p><strong>æ–‡ä»¶ï¼š</strong>${debugData.filename} (${formatFileSize(debugData.attachSize)})</p>
                                    <a href="${attachUrl}" download="${debugData.filename}" class="button secondary">ğŸ“¥ å°è¯•ä¸‹è½½æ–‡ä»¶</a>
                                </div>
                            </div>
                        `;
                    }
                }

                // æ·»åŠ å¼€å‘æ¨¡å¼è°ƒè¯•ä¿¡æ¯
                if (devMode) {
                    resultHtml += `
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; font-family: monospace; font-size: 0.85em;">
                            <h4>ğŸ”§ æ ¼å¼è°ƒè¯•ä¿¡æ¯</h4>
                            <p><strong>æ–‡ä»¶å¤§å°ï¼š</strong>${debugData.fileSize} å­—èŠ‚</p>
                            <p><strong>é­”æœ¯å­—èŠ‚ï¼š</strong>"${debugData.magicBytes}" (ä½ç½®: ${debugData.positions.magicBytes})</p>
                            <p><strong>è§†é¢‘å¤§å°ï¼š</strong>${debugData.videoSize} å­—èŠ‚ (ä½ç½®: ${debugData.positions.videoSize})</p>
                            <p><strong>é™„åŠ æ–‡ä»¶å¤§å°ï¼š</strong>${debugData.attachSize} å­—èŠ‚ (ä½ç½®: ${debugData.positions.attachSize})</p>
                            <p><strong>æ–‡ä»¶åé•¿åº¦ï¼š</strong>${debugData.filenameLength}</p>
                            <p><strong>æ–‡ä»¶åï¼š</strong>"${debugData.filename}"</p>
                            <p><strong>å…ƒæ•°æ®å¼€å§‹ï¼š</strong>${debugData.positions.metadataStart}</p>
                        </div>
                    `;
                }

                resultHtml += `
                    <p style="font-size: 0.85em; color: #666; margin-top: 15px;">
                        ğŸ’¡ ä¸‹è½½æç¤ºï¼šå¦‚æœä¸‹è½½æ²¡æœ‰å¼€å§‹ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨çš„ä¸‹è½½è®¾ç½®æˆ–å¼¹çª—æ‹¦æˆªå™¨
                    </p>
                `;

                resultEl.innerHTML = resultHtml;
                resultEl.className = debugData.errors.length === 0 ? 'result' : 'result error';
                resultEl.style.display = 'block';

                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 1000);

                addDebugInfo(`æ‹†åˆ†å®Œæˆ: é”™è¯¯æ•°=${debugData.errors.length}`);

            } catch (error) {
                if (error.message !== 'æ“ä½œå·²å–æ¶ˆ') {
                    // å³ä½¿åœ¨é”™è¯¯æƒ…å†µä¸‹ï¼Œä¹Ÿæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                    let errorHtml = `<h3>âŒ æ‹†åˆ†å¤±è´¥</h3><p>${error.message}</p>`;
                    
                    if (devMode) {
                        errorHtml += `
                            <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 8px; font-family: monospace; font-size: 0.85em;">
                                <h4>ğŸ”§ é”™è¯¯æ—¶çš„è°ƒè¯•ä¿¡æ¯</h4>
                                <p><strong>æ–‡ä»¶å¤§å°ï¼š</strong>${debugData.fileSize} å­—èŠ‚</p>
                                <p><strong>é­”æœ¯å­—èŠ‚ï¼š</strong>"${debugData.magicBytes}"</p>
                                <p><strong>è§†é¢‘å¤§å°ï¼š</strong>${debugData.videoSize}</p>
                                <p><strong>é™„åŠ æ–‡ä»¶å¤§å°ï¼š</strong>${debugData.attachSize}</p>
                                <p><strong>æ–‡ä»¶åé•¿åº¦ï¼š</strong>${debugData.filenameLength}</p>
                                <p><strong>æ–‡ä»¶åï¼š</strong>"${debugData.filename}"</p>
                                <p><strong>æ£€æµ‹åˆ°çš„é”™è¯¯ï¼š</strong></p>
                                <ul>${debugData.errors.map(err => `<li>${err}</li>`).join('')}</ul>
                            </div>
                        `;
                    }
                    
                    resultEl.innerHTML = errorHtml;
                    resultEl.className = 'result error';
                    resultEl.style.display = 'block';
                }
            } finally {
                splitBtn.disabled = false;
                cancelBtn.style.display = 'none';
                currentOperation = null;
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        initializeSystem();
    </script>
</body>

</html>